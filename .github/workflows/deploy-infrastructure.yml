name: Deploy Hub + Spokes Infrastructure

on:
  push:
    branches: [ main ]
    paths:
      - 'cloudformation/**/*.yaml'
      - '.github/workflows/deploy-infrastructure.yml'
  workflow_dispatch:

env:
  AWS_REGION: us-west-1
  HUB_ACCOUNT_ID: "881490088884"
  SPOKE_A_ACCOUNT_ID: "414329322210"
  SPOKE_B_ACCOUNT_ID: "417371242369"

############################################################
# JOB 1 — DEPLOY HUB (VPC + TGW + RAM SHARE)
############################################################
jobs:
  deploy-hub:
    name: Deploy Hub Networking
    runs-on: ubuntu-latest

    outputs:
      tgw_id: ${{ steps.get-tgw.outputs.tgw_id }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (Hub)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Hub CloudFormation Stack
        run: |
          aws cloudformation deploy \
            --stack-name hub-networking \
            --template-file cloudformation/hub/centralized-vpc.yaml \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides \
              EnvironmentName=Hub \
              VpcCIDR=10.0.0.0/16 \
              PublicSubnet1CIDR=10.0.1.0/24 \
              PublicSubnet2CIDR=10.0.2.0/24 \
              PrivateSubnet1CIDR=10.0.11.0/24 \
              PrivateSubnet2CIDR=10.0.12.0/24 \
              SpokeAAccountId=${{ env.SPOKE_A_ACCOUNT_ID }} \
              SpokeBAccountId=${{ env.SPOKE_B_ACCOUNT_ID }} \
            --no-fail-on-empty-changeset

      - name: Extract Transit Gateway ID
        id: get-tgw
        run: |
          TGW_ID=$(aws cloudformation describe-stacks \
            --stack-name hub-networking \
            --query "Stacks[0].Outputs[?OutputKey=='TransitGatewayId'].OutputValue" \
            --output text)

          echo "tgw_id=$TGW_ID" >> $GITHUB_OUTPUT
          echo "Transit Gateway ID: $TGW_ID"

      - name: Wait for RAM share propagation
        run: |
          echo "Waiting for TGW RAM share propagation..."
          sleep 60

############################################################
# JOB 2 — DEPLOY SPOKES USING STACKSET
############################################################
  deploy-spokes:
    name: Deploy Spoke StackSet
    runs-on: ubuntu-latest
    needs: deploy-hub

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (Hub – StackSet Admin)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      ########################################################
      # CREATE OR UPDATE STACKSET DEFINITION
      ########################################################
      - name: Create or Update Spoke StackSet
        id: stackset
        run: |
          STACKSET_NAME="Spoke-Centralized"

          if aws cloudformation describe-stack-set \
            --stack-set-name "$STACKSET_NAME" >/dev/null 2>&1; then

            echo "Updating existing StackSet..."
            aws cloudformation update-stack-set \
              --stack-set-name "$STACKSET_NAME" \
              --template-body file://cloudformation/spoke/spoke-vpc.yaml \
              --capabilities CAPABILITY_NAMED_IAM

          else
            echo "Creating new StackSet..."
            aws cloudformation create-stack-set \
              --stack-set-name "$STACKSET_NAME" \
              --template-body file://cloudformation/spoke/spoke-vpc.yaml \
              --administration-role-arn arn:aws:iam::${{ env.HUB_ACCOUNT_ID }}:role/AWSCloudFormationStackSetAdministrationRole \
              --execution-role-name AWSCloudFormationStackSetExecutionRoleSumanth \
              --capabilities CAPABILITY_NAMED_IAM
          fi

      ########################################################
      # CREATE OR UPDATE STACK INSTANCES (IDEMPOTENT)
      ########################################################
      - name: Deploy Spoke A & Spoke B Stack Instances
        run: |
          STACKSET_NAME="Spoke-Centralized"
          REGION="${{ env.AWS_REGION }}"
          TGW_ID="${{ needs.deploy-hub.outputs.tgw_id }}"
          ACCOUNTS="${{ env.SPOKE_A_ACCOUNT_ID }} ${{ env.SPOKE_B_ACCOUNT_ID }}"

          EXISTING_ACCOUNTS=$(aws cloudformation list-stack-instances \
            --stack-set-name "$STACKSET_NAME" \
            --region "$REGION" \
            --query "Summaries[].Account" \
            --output text)

          OPERATION="create-stack-instances"

          for ACCOUNT in $ACCOUNTS; do
            if echo "$EXISTING_ACCOUNTS" | grep -q "$ACCOUNT"; then
              OPERATION="update-stack-instances"
              break
            fi
          done

          echo "Using operation: $OPERATION"

          aws cloudformation $OPERATION \
            --stack-set-name "$STACKSET_NAME" \
            --accounts $ACCOUNTS \
            --regions "$REGION" \
            --parameter-overrides \
              ParameterKey=TransitGatewayId,ParameterValue=$TGW_ID \
            --operation-preferences \
              FailureToleranceCount=1,MaxConcurrentCount=2

      - name: Deployment Complete
        run: |
          echo "Hub + Spoke A + Spoke B deployment completed successfully"
