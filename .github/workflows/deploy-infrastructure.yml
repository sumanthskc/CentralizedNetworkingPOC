name: Deploy Hub + Spokes Infrastructure

on:
  push:
    branches: [ main ]
    paths:
      - 'cloudformation/**/*.yaml'
      - '.github/workflows/deploy-infrastructure.yml'
  workflow_dispatch:

env:
  AWS_REGION: us-west-1
  HUB_ACCOUNT_ID: "881490088884"
  SPOKE_A_ACCOUNT_ID: "414329322210"
  SPOKE_B_ACCOUNT_ID: "417371242369"

###############################################################################
# HUB DEPLOYMENT
###############################################################################
jobs:
  deploy-hub:
    name: Deploy Hub VPC + Transit Gateway
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Hub Stack
        run: |
          aws cloudformation deploy \
            --stack-name hub-networking \
            --template-file cloudformation/hub/centralized-vpc.yaml \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides \
              EnvironmentName=Hub \
              VpcCIDR=10.0.0.0/16 \
              PublicSubnet1CIDR=10.0.1.0/24 \
              PublicSubnet2CIDR=10.0.2.0/24 \
              PrivateSubnet1CIDR=10.0.11.0/24 \
              PrivateSubnet2CIDR=10.0.12.0/24 \
            --no-fail-on-empty-changeset

      - name: Extract Transit Gateway ID
        id: tgw
        run: |
          TGW_ID=$(aws cloudformation describe-stacks \
            --stack-name hub-networking \
            --query "Stacks[0].Outputs[?OutputKey=='TransitGatewayId'].OutputValue" \
            --output text)
          echo "tgw_id=$TGW_ID" >> $GITHUB_OUTPUT

    outputs:
      tgw_id: ${{ steps.tgw.outputs.tgw_id }}

###############################################################################
# SPOKE STACKSET DEPLOYMENT
###############################################################################
  deploy-spokes:
    name: Deploy Spoke StackSet (Fully Synchronized)
    runs-on: ubuntu-latest
    needs: deploy-hub

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      #########################################################################
      # CREATE OR UPDATE STACKSET (DEFINITION)
      #########################################################################
      - name: Create or Update StackSet
        id: stackset
        run: |
          STACKSET="Spoke-Centralized"

          if aws cloudformation describe-stack-set \
            --stack-set-name "$STACKSET" >/dev/null 2>&1; then
            echo "Updating StackSet definition..."

            OPERATION_ID=$(aws cloudformation update-stack-set \
              --stack-set-name "$STACKSET" \
              --template-body file://cloudformation/spoke/spoke-vpc.yaml \
              --capabilities CAPABILITY_NAMED_IAM \
              --query OperationId \
              --output text)
          else
            echo "Creating StackSet..."

            OPERATION_ID=$(aws cloudformation create-stack-set \
              --stack-set-name "$STACKSET" \
              --template-body file://cloudformation/spoke/spoke-vpc.yaml \
              --administration-role-arn arn:aws:iam::${{ env.HUB_ACCOUNT_ID }}:role/AWSCloudFormationStackSetAdministrationRole \
              --execution-role-name AWSCloudFormationStackSetExecutionRoleSumanth \
              --capabilities CAPABILITY_NAMED_IAM \
              --query OperationId \
              --output text)
          fi

          echo "operation_id=$OPERATION_ID" >> $GITHUB_OUTPUT
          echo "StackSet definition operation started: $OPERATION_ID"


      #########################################################################
      # CREATE OR UPDATE STACK INSTANCES (IDEMPOTENT)
      #########################################################################
      - name: Deploy or Update Spoke A & B
        id: instances
        run: |
          STACKSET="Spoke-Centralized"
          REGION="${{ env.AWS_REGION }}"
          TGW_ID="${{ needs.deploy-hub.outputs.tgw_id }}"
          ACCOUNTS="${{ env.SPOKE_A_ACCOUNT_ID }} ${{ env.SPOKE_B_ACCOUNT_ID }}"

          EXISTING=$(aws cloudformation list-stack-instances \
            --stack-set-name $STACKSET \
            --region $REGION \
            --query "Summaries[].Account" \
            --output text)

          OPERATION="create-stack-instances"

          for ACCOUNT in $ACCOUNTS; do
            if echo "$EXISTING" | grep -q "$ACCOUNT"; then
              OPERATION="update-stack-instances"
              break
            fi
          done

          echo "Using instance operation: $OPERATION"

          OPERATION_ID=$(aws cloudformation $OPERATION \
            --stack-set-name $STACKSET \
            --accounts $ACCOUNTS \
            --regions $REGION \
            --parameter-overrides \
              ParameterKey=TransitGatewayId,ParameterValue=$TGW_ID \
            --operation-preferences \
              FailureToleranceCount=1,MaxConcurrentCount=2 \
            --query OperationId \
            --output text)

          echo "operation_id=$OPERATION_ID" >> $GITHUB_OUTPUT
          echo "StackSet instance operation started: $OPERATION_ID"

      #########################################################################
      # WAIT FOR STACK INSTANCES
      #########################################################################
      - name: Wait for StackSet instances to complete
        run: |
          aws cloudformation wait stack-set-operation-complete \
            --stack-set-name Spoke-Centralized \
            --operation-id ${{ steps.instances.outputs.operation_id }}

      - name: Deployment Complete
        run: |
          echo "Hub + Spoke A + Spoke B deployment completed successfully"
